<!DOCTYPE html>
<html class="t-grey">
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Chat Application Using Xmpp Smack Api Android Tutorial</title>
  <meta name="description" content="  The final project is available for download from the Github repository">

  <link href='https://fonts.googleapis.com/css?family=Roboto:400,400italic,700|Roboto+Mono:400,500' rel='stylesheet' type='text/css'>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="/iOSAndroidChaosOverFlow/css/main.css">
  <link rel="canonical" href="http://shubhank101.github.io/iOSAndroidChaosOverFlow/2016/10/Chat-Application-Using-XMPP-Smack-API-Android-Tutorial">
  <link rel="alternate" type="application/rss+xml" title="iOS/Android [ChaosOverFlow]" href="http://shubhank101.github.io/iOSAndroidChaosOverFlow/feed.xml">
  
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  
    ga('create', 'UA-78888527-1', 'auto');
    ga('send', 'pageview');

  </script>
  
</head>

  <body>
    <nav class="c-navigation is-fixed">
  <div class="c-navigation__container u-container">
    <a class="c-navigation__item " href="/iOSAndroidChaosOverFlow/">Home</a>
    <a class="c-navigation__item " href="/iOSAndroidChaosOverFlow/tutorials/">Tutorial</a>
    <a class="c-navigation__item " href="/iOSAndroidChaosOverFlow/about/">About</a>
    <a class="c-navigation__item " target="_blank" href="http://chat.stackoverflow.com/rooms/26424/iosandroidchaosoverflow">Join Chat</a>    
  </div>
  
</nav>


    <article class="c-article">
  <header class="c-header c-article__header">
    <div class="u-container">
      <h1 class="c-header__title">Chat Application Using Xmpp Smack Api Android Tutorial</h1>
    </div>
  </header>

  <div class="c-article__main">
    <blockquote>
  <p>The final project is available for download from the <a href="https://github.com/Shubhank101/iOSAndroidChaosOverFlow-Projects">Github repository</a></p>
</blockquote>

<h2 id="what-is-xmpp">What is XMPP?</h2>

<p><strong>Extensible Messaging and Presence Protocol</strong> (XMPP) is an open XML technology for real-time communication as explained in the official <a href="https://xmpp.org/about">site</a> info section.</p>

<p>Main Benefits of using it is its feature such as Presence to notify user state as well as being <strong>extensible</strong> therefore allowing you to extend its capibility to <strong>send Images and Video too</strong>.
Other solutions do not provide such advance features and to add user states such as typing/away is very hard to implement yet core to a chat app. Therefore, XMPP is a good choice for chat apps.</p>

<hr />

<h2 id="roadmap-of-tutorial">Roadmap of Tutorial</h2>

<p>Before we move on to explaining things and to code, a little review of what this tutorial will cover will be good.</p>

<h4 id="how-to-run-a-ejabberd-server-on-your-maclocalhost">1) How To Run A Ejabberd Server On Your Mac/Localhost</h4>
<p>We will be running a ejabberd xmpp server for our chat app. Steps to install and configure it will be given.</p>

<p style="height:2px" />

<h4 id="registering-a-user-through-terminal">2) Registering A User Through Terminal</h4>
<p>It’s good to get familiar with the working of server using terminal for future use. You can read and explore more on ejabberd site.</p>

<p style="height:2px" />

<h4 id="usingregistering-account-on-adium-a-jabber-client">3) Using/Registering Account On Adium (A Jabber Client)</h4>
<p>To be able to chat between two user, we need to have our app (first client) and another client for user2. Adium will act as the second user</p>

<p style="height:2px" />

<h4 id="log-in-the-user-on-the-server-with-the-android-app">4) Log In The User On The Server With The Android App</h4>
<p>Connecting and Login with the server plus handling errors will be explained.</p>

<p style="height:2px" />

<h4 id="sending-tofro-message-to-the-other-user-through-android-app">5) Sending To/Fro Message To The Other User Through Android App.</h4>
<p>This part will have us code for messages coming from other user as well as sending message from the app.</p>

<hr />

<h2 id="step-1-downloading-ejabbered">Step 1. Downloading ejabbered</h2>

<p>We will be using <a href="https://www.ejabberd.im/">ejabbered</a> server for our app.<br />
There are several xmpp servers available out there, <a href="https://www.igniterealtime.org/projects/openfire/">Openfire</a> being a popular alternative.</p>

<p>Go ahead and download the ejabbered community server installer from <a href="https://www.process-one.net/en/ejabberd/downloads/">here</a>.</p>

<p>• Run the Setup</p>
<p style="height:2px" />

<p><img src="http://i.imgur.com/Lbzrn9o.jpg" alt="ejabbered setup" /></p>
<p style="height:2px" />

<p>• Install it to the Default Path which will be something like <code class="highlighter-rouge">Applications/ejabbered/</code> on the Mac OS X.</p>
<p style="height:2px" />

<p>• For the server name - you can use <strong>localhost</strong></p>
<p style="height:2px" />

<p><img src="http://i.imgur.com/aFFdNJH.jpg" alt="Server Name" /></p>
<p style="height:2px" />

<p>• Use <strong>Admin</strong> as the admin name and 12345 for the password for now</p>
<p style="height:2px" />

<p><img src="http://i.imgur.com/8zreCEm.jpg" alt="admin name" /></p>
<p style="height:2px" />

<p><img src="http://i.imgur.com/zo48KPI.jpg" alt="password" /></p>
<p style="height:2px" />

<p>• ejabbered will install now. Click done at the final screen.</p>
<p style="height:2px" />

<p><img src="http://i.imgur.com/OzBuEmc.jpg" alt="ejabber installing" /></p>
<p style="height:2px" />

<hr />

<h2 id="step-2-registering-a-user-through-terminal">Step 2. Registering A User Through Terminal</h2>

<p>Steps are also explained here for your reference <a href="https://docs.ejabberd.im/developer/install-osx/">https://docs.ejabberd.im/developer/install-osx/</a>.</p>

<p>• Open a Terminal folder and cd into the ejabberd path.</p>

<p>For version 16.06 in Mac OS X. The command will be  <code class="highlighter-rouge">cd /Applications/ejabberd-16.06</code></p>
<p style="height:2px" />

<p><img src="http://i.imgur.com/My1AyvU.png" alt="ejabbered path in terminal" /></p>
<p style="height:2px" />

<p>• To run the server use the command. <code class="highlighter-rouge">sbin/ejabberdctl live</code></p>
<p style="height:2px" />

<p><img src="http://i.imgur.com/My1AyvU.png" alt="ejabbered path in terminal" /></p>
<p style="height:2px" />

<p>• To register the user -&gt; use the syntax <strong>register username servername pass</strong>.<br />
The one i have used <code class="highlighter-rouge">bin/ejabberdctl register user1 localhost pass</code></p>
<p style="height:2px" />

<p><img src="http://i.imgur.com/1Kx5BDO.png" alt="ejabbered path in terminal" /></p>
<p style="height:2px" />

<hr />

<h2 id="step-3-usingregistering-account-on-adium-a-jabber-client">Step 3. Using/Registering Account On Adium (A Jabber Client)</h2>

<p>Since our server is setup using a XMPP  based protocol, we will be using a jabber client to connect to our server and check out how it performs.
Go ahead and <strong>download Adium</strong> from <a href="https://adium.im/">https://adium.im/</a>.</p>

<p>Install it and launch it, close any account assitant setup if it comes. Now you will see a screen something like this :</p>

<p><img src="http://i.imgur.com/0byM6pM.jpg" alt="Adium" /></p>

<p>• Now open Adium preferences from the top menu.</p>

<p style="height:2px" />

<p><img src="http://i.imgur.com/m4fKgnE.jpg" alt="Adium Preference" /></p>
<p style="height:2px" />

<p>• In Account click the add button at the bottom left and select xmpp jabber account</p>
<p style="height:2px" />

<p><img src="http://i.imgur.com/5EnRRGJ.jpg" alt="Adium Xabber account" /></p>
<p style="height:2px" />

<p>• Enter the username@host and then a pass - i kept 123</p>
<p style="height:2px" />

<p><img src="http://i.imgur.com/ZpugE5w.jpg" alt="Username pass" /></p>
<p style="height:2px" />

<p>• A alert will come with the text <strong>“Requested URL was not found on this server”</strong>: Click ok.
Now in the server - enter the host name i.e <strong>localhost</strong> in our case</p>
<p style="height:2px" />

<p><img src="http://i.imgur.com/fnK4vNE.jpg" alt="Username pass" /></p>
<p style="height:2px" />

<p>Clicking <strong>request new account</strong> will now register this and you will have the adium client setup for this.</p>

<hr />

<h2 id="step-4-log-in-the-user-on-the-server-with-the-android-app">Step 4. Log In The User On The Server With The Android App</h2>

<p>Now with our server setup and adium running with the second user, time to move to <strong>Android Studio</strong> to build the chat app.</p>

<p>Open up Studio and create a new basic activity template project named <strong>XMPP</strong>.</p>

<h3 id="setup-gradle-for-smack">Setup Gradle for Smack</h3>

<p>We will be using <a href="https://www.igniterealtime.org/projects/smack/">SMACK</a> for connecting to the server. It is a open source, well documented client API for xmpp.<br />
Below is the gradle dependecies we will be using:</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml">dependencies {
    compile fileTree(dir: 'libs', include: ['*.jar'])
    testCompile 'junit:junit:4.12'
    compile 'com.android.support:appcompat-v7:23.3.0'
    compile "org.igniterealtime.smack:smack-tcp:4.1.0"

    // Optional for XMPPTCPConnection
    compile "org.igniterealtime.smack:smack-android-extensions:4.1.0"

}</code></pre></figure>

<p>Sync your project.</p>

<h3 id="mainactivity-code">MainActivity Code</h3>

<figure class="highlight"><pre><code class="language-java" data-lang="java">    
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainActivity</span> <span class="kd">extends</span> <span class="n">AppCompatActivity</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="n">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
        <span class="n">setContentView</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">activity_main</span><span class="o">);</span>
        <span class="n">MyLoginTask</span> <span class="n">task</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MyLoginTask</span><span class="o">();</span>
        <span class="n">task</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="s">""</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">class</span> <span class="nc">MyLoginTask</span> <span class="kd">extends</span> <span class="n">AsyncTask</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="n">String</span> <span class="n">doInBackground</span><span class="o">(</span><span class="n">String</span><span class="o">...</span> <span class="n">params</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// Create a connection to the jabber.org server.</span>
            <span class="n">XMPPTCPConnectionConfiguration</span> <span class="n">config</span> <span class="o">=</span> <span class="n">XMPPTCPConnectionConfiguration</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">setUsernameAndPassword</span><span class="o">(</span><span class="s">"user1"</span><span class="o">,</span> <span class="s">"123"</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">setHost</span><span class="o">(</span><span class="s">"10.0.2.2"</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">setSecurityMode</span><span class="o">(</span><span class="n">ConnectionConfiguration</span><span class="o">.</span><span class="na">SecurityMode</span><span class="o">.</span><span class="na">disabled</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">setServiceName</span><span class="o">(</span><span class="s">"localhost"</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">setPort</span><span class="o">(</span><span class="mi">5222</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">setDebuggerEnabled</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="c1">// to view what's happening in detail</span>
                    <span class="o">.</span><span class="na">build</span><span class="o">();</span>

            <span class="n">AbstractXMPPConnection</span> <span class="n">conn1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">XMPPTCPConnection</span><span class="o">(</span><span class="n">config</span><span class="o">);</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">conn1</span><span class="o">.</span><span class="na">connect</span><span class="o">();</span>
                <span class="k">if</span><span class="o">(</span><span class="n">conn1</span><span class="o">.</span><span class="na">isConnected</span><span class="o">())</span> <span class="o">{</span>
                    <span class="n">Log</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="s">"app"</span><span class="o">,</span> <span class="s">"conn done"</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="n">conn1</span><span class="o">.</span><span class="na">login</span><span class="o">();</span>
                
                <span class="k">if</span><span class="o">(</span><span class="n">conn1</span><span class="o">.</span><span class="na">isAuthenticated</span><span class="o">())</span> <span class="o">{</span>
                    <span class="n">Log</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="s">"app"</span><span class="o">,</span> <span class="s">"Auth done"</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">Log</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="s">"app"</span><span class="o">,</span> <span class="n">e</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
            <span class="o">}</span>

            <span class="k">return</span> <span class="s">""</span><span class="o">;</span>
        <span class="o">}</span>


        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="kt">void</span> <span class="n">onPostExecute</span><span class="o">(</span><span class="n">String</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">}</span>

    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>We create a AsyncTask class <code class="highlighter-rouge">MyLoginTask</code> to do the network request and authentication in background thread and call it from our <code class="highlighter-rouge">onCreate()</code> method.</p>

<p>In the <code class="highlighter-rouge">doInBackground</code> we create our <strong>config</strong> object, fields we set are <strong>usernameAndPassword</strong> of user1 we created using terminal.<br />
The host set is <strong>10.0.2.2</strong> instead of localhost since android emulator refers localhost to itself so we need to use 10.0.2.2 for our emulator to connect to Mac’s localhost.</p>

<p>Security is disabled and the service name for our connection purpose we specify as localhost. Next we set the default xmpp port of 5222 and <code class="highlighter-rouge">setDebuggerEnabled(true)</code> so that we receive <strong>proper logs of any connection failure/success</strong>.</p>

<p>With this config we create our connection object and try to connect to our server and subsequently login. Calling <code class="highlighter-rouge">conn1.isAuthenticated()</code> will return us whether the user has been authenticated with the server.<br />
All of the connection and auth call are wrapped in a <strong>try catch</strong> so that we can catch any failure and take proper action.</p>

<p>Run the app and if everything has been followed correctly, you will see the <strong>auth Done</strong> log in the console.</p>

<hr />

<h2 id="step-5-recieve-message-from-the-other-user-through-android-app">Step 5. Recieve Message From The Other User Through Android App.</h2>

<p>Add the following code in the <code class="highlighter-rouge">isAuthenticated</code> condition of the asynctask.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="k">if</span><span class="o">(</span><span class="n">conn1</span><span class="o">.</span><span class="na">isAuthenticated</span><span class="o">())</span>
  <span class="o">{</span>
      <span class="n">Log</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="s">"app"</span><span class="o">,</span> <span class="s">"Auth done"</span><span class="o">);</span>
      <span class="n">ChatManager</span> <span class="n">chatManager</span> <span class="o">=</span> <span class="n">ChatManager</span><span class="o">.</span><span class="na">getInstanceFor</span><span class="o">(</span><span class="n">conn1</span><span class="o">);</span>
      <span class="n">chatManager</span><span class="o">.</span><span class="na">addChatListener</span><span class="o">(</span>
          <span class="k">new</span> <span class="n">ChatManagerListener</span><span class="o">()</span> <span class="o">{</span>
              <span class="nd">@Override</span>
              <span class="kd">public</span> <span class="kt">void</span> <span class="n">chatCreated</span><span class="o">(</span><span class="n">Chat</span> <span class="n">chat</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">createdLocally</span><span class="o">)</span>
              <span class="o">{</span>
                  <span class="n">chat</span><span class="o">.</span><span class="na">addMessageListener</span><span class="o">(</span><span class="k">new</span> <span class="n">ChatMessageListener</span><span class="o">()</span>
                  <span class="o">{</span>
                      <span class="nd">@Override</span>
                      <span class="kd">public</span> <span class="kt">void</span> <span class="n">processMessage</span><span class="o">(</span><span class="n">Chat</span> <span class="n">chat</span><span class="o">,</span> <span class="n">Message</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
                          <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Received message: "</span>
                                  <span class="o">+</span> <span class="o">(</span><span class="n">message</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">message</span><span class="o">.</span><span class="na">getBody</span><span class="o">()</span> <span class="o">:</span> <span class="s">"NULL"</span><span class="o">));</span>
                      <span class="o">}</span>
                  <span class="o">});</span>

                  <span class="n">Log</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="s">"app"</span><span class="o">,</span> <span class="n">chat</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
              <span class="o">}</span>
          <span class="o">});</span>
<span class="o">}</span></code></pre></figure>

<p>Here we add a <code class="highlighter-rouge">chatListener</code> to our ChatManager class provided by Smack for the current xmpp connection.<br />
We override the chat created method which will be called for each conversation with different users.<br />
In the <code class="highlighter-rouge">chatCreated</code> method we add a <code class="highlighter-rouge">ChatMessageListener</code> which provides us with the message body of the chat and many other attributes such as user name, time stamp etc.</p>

<p>Now run the app and <strong>send message to user1 from Adium client</strong>. You shall see in the logs proper message being received.</p>

<h2 id="conclusion">Conclusion</h2>

<p><strong>Thank you</strong> for reading this far. For any questions you are welcome to ask in our chat room.</p>

<h3 id="for-further-info">For further info</h3>

<p><a href="https://www.igniterealtime.org/projects/smack/">Smack</a></p>

<p><a href="https://en.wikipedia.org/wiki/XMPP">XMPP Wikipedia</a></p>

<h2 id="next-steps">Next Steps</h2>

<p>Please take a look at our other <a href="../../tutorials">tutorials</a> :)</p>


  </div>
<div id="disqus_thread" style="width:80%; margin-left: auto; margin-right: auto"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'chaosoverflow'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</article>


    <footer class="c-footer">
  <div class="u-container c-footer__container">
    <p> &copy; iOS/Android [ChaosOverFlow] 2016 </a> </p>
    <p>
      Author : <a href="http://github.com/Shubhank101" > Shubhank </a> 
      
      
      
      
    </p>
  </div>
</footer>

  </body>
</html>
